GoIndex Refactored for Cloudflare Workers 中文部署与使用指南
这是一个功能强大、经过重构和优化的 Google Drive 目录索引程序。它被设计为在 Cloudflare Workers 上运行，利用其全球网络和 KV 存储，为您提供一个高性能、免费、免服务器的 Google Drive 文件分享和浏览解决方案。

此版本 (v2.3.5-refactored) 在原版基础上进行了大量代码优化，并增加了现代化功能，如增强的播放器、优化的管理后台和更稳定的缓存机制。

✨ 主要功能
多云盘支持: 可同时挂载多个 Google Drive 云盘（个人盘、团队盘、甚至特定文件夹）。

高效 KV 缓存: 全面利用 Cloudflare KV 存储，缓存文件列表和路径信息，实现秒级加载，极大降低 Google Drive API 调用频率。

自动化 Cron 更新: 通过 Cloudflare Cron 触发器，每日自动更新全量文件缓存，确保搜索数据保持最新，无需人工干预。

现代化前端界面:

响应式设计，完美适配桌面和移动设备。

支持浅色/深色主题一键切换。

清晰的文件列表和面包屑导航。

强大的文件搜索: 基于全量缓存的快速文件搜索功能。

功能丰富的播放器: 集成 Plyr.io 播放器，支持视频和音频在线播放，提供倍速、画中画、清晰度选择等高级功能。

后台管理面板:

密码保护，安全可靠。

直观地查看所有云盘的缓存状态、文件数量和更新时间。

支持一键清理指定云盘或所有云盘的缓存。

支持手动强制更新某个云盘的搜索缓存。

基础身份验证: 可为每个挂载的云盘单独设置用户名和密码访问。

直接下载与流式传输: 支持文件直接下载和流式传输到本地播放器（如 PotPlayer, VLC）。

🚀 部署指南
部署过程分为三个主要步骤：获取 Google API 凭证、配置 Cloudflare Worker、配置脚本。请耐心按照以下步骤操作。

准备工作
一个 Google 账号。

一个 Cloudflare 账号。

步骤一：获取 Google Drive API 凭证
这是最关键的一步，您需要获取三个凭证：CLIENT_ID, CLIENT_SECRET, 和 REFRESH_TOKEN。

登录 Google Cloud Console:

访问 Google Cloud Console。

在页面顶部，点击项目选择器，然后点击 "新建项目"。输入一个项目名称（例如 my-gdrive-worker），然后点击“创建”。

启用 Google Drive API:

在左侧导航菜单中，找到 "API 和服务" -> "已启用的 API 和服务"。

点击顶部的 "+ 启用 API 和服务"。

搜索 "Google Drive API"，找到并点击进入，然后点击“启用”。

创建 OAuth 2.0 凭据:

在左侧导航菜单中，选择 "API 和服务" -> "OAuth 同意屏幕"。

选择“外部”，然后点击“创建”。

填写应用名称（例如 GoIndex Worker），并选择您的用户支持电子邮箱。

在页面底部，填写开发者联系信息（您的邮箱即可），然后点击“保存并继续”。

在“范围”页面，直接点击“保存并继续”。

在“测试用户”页面，点击“+ ADD USERS”，输入您自己的 Google 邮箱地址，然后点击“添加”。最后点击“保存并继续”。

返回信息中心，点击左侧的“凭据”。

点击顶部的“+ 创建凭据”，选择“OAuth 客户端 ID”。

在“应用类型”中选择“Web 应用”。

为您的凭据命名（例如 Worker Credentials）。

在“已获授权的重定向 URI”部分，点击“+ 添加 URI”，然后粘贴以下地址：

https://developers.google.com/oauthplayground

点击“创建”。您将看到一个弹窗，其中包含您的 客户端 ID 和 客户端密钥。请立即复制并妥善保存它们，它们分别对应脚本需要的 CLIENT_ID 和 CLIENT_SECRET。

获取 REFRESH_TOKEN:

打开 Google OAuth 2.0 Playground。

点击右上角的齿轮图标 ⚙️，勾选 "Use your own OAuth credentials"。

将您上一步获取的 客户端 ID 和 客户端密钥 粘贴进去，然后关闭设置。

在左侧 "Step 1" 的输入框中，找到并粘贴以下 Drive API 范围：

https://www.googleapis.com/auth/drive.readonly

点击蓝色的 "Authorize APIs" 按钮。

使用您之前添加为“测试用户”的 Google 账号登录并授权。

授权成功后，您将被重定向回来。在 "Step 2" 中，点击 "Exchange authorization code for tokens" 按钮。

在右侧的 "Response" 中，您将看到 Refresh token。复制这个长字符串，这就是您需要的 REFRESH_TOKEN。

至此，您已经成功获取了全部三个必需的凭证。

步骤二：配置 Cloudflare Worker
创建 Worker 服务:

登录 Cloudflare 控制台，进入 "Workers 和 Pages" 页面。

点击“创建应用程序”，然后选择“创建 Worker”。

为您的 Worker 命名（例如 gdrive-indexer），然后点击“部署”。

粘贴代码:

部署成功后，点击“编辑代码”。

将本 README.md 文件附带的 goindex-refactored.js 脚本的全部内容复制并粘贴到代码编辑器中，覆盖掉原有的示例代码。

创建并绑定 KV 命名空间:

返回到您的 Worker 的主配置页面。

点击“设置” -> “变量”。

向下滚动到 “KV 命名空间绑定”，点击“添加绑定”。

变量名称必须填写 GD_INDEX_CACHE。

点击“KV 命名空间”下拉框，选择“创建命名空间”。输入一个名称（例如 GOINDEX_CACHE），然后点击“创建”。

点击“保存并部署”。

设置环境变量:

在同一页面（“设置” -> “变量”），找到“环境变量”部分，点击“添加变量”。

您需要添加以下五个变量（点击“加密”可以保护敏感信息）：

CLIENT_ID: 粘贴您获取的客户端 ID。

CLIENT_SECRET: 粘贴您获取的客户端密钥。

REFRESH_TOKEN: 粘贴您获取的刷新令牌。

ADMIN_PASS: 设置一个您自己的后台管理密码。

DRIVE_ROOTS: 这是最关键的云盘配置，请参考下一步的详细说明。

步骤三：配置 DRIVE_ROOTS 变量
这个变量是一个 JSON 数组，用于定义您要挂载的云盘。请确保它是有效的、单行的 JSON，不包含注释或末尾的逗号。

基本结构:

[
  { "id": "云盘或文件夹ID", "name": "显示的名称", "user": "用户名(可选)", "pass": "密码(可选)" },
  { "id": "另一个云盘ID", "name": "另一个名称" }
]

如何获取 id:

个人“我的云端硬盘”: ID 固定为 root。

共享云盘 (团队盘): 打开共享云盘，浏览器地址栏 URL 的最后一部分就是它的 ID。例如 .../drive/folders/0A1B2c3d4E5f6Uk9PVA，ID 就是 0A1B2c3d4E5f6Uk9PVA。

特定文件夹: 打开该文件夹，地址栏 URL 的最后一部分就是它的 ID。

示例配置:

[{"id":"root","name":"My Drive"},{"id":"0A1B2c3d4E5f6Uk9PVA","name":"Team Drive"},{"id":"1G_aBcDeFgHiJkLmNoPqRsTuVwXyZ_789","name":"学习资料","user":"guest","pass":"12345"}]

上面的示例挂载了三个盘：个人盘、一个团队盘、以及一个需要用户名和密码才能访问的“学习资料”文件夹。

将您配置好的 JSON 数组压缩成一行后，粘贴到 DRIVE_ROOTS 环境变量的值中。

步骤四：配置 Cron 触发器
在 Worker 的配置页面，点击“设置” -> “触发器”。

在“Cron 触发器”部分，点击“添加 Cron 触发器”。

强烈建议使用 Cron 表达式 0 * * * *。

这表示“每小时的第 0 分钟执行一次”。

脚本内部的 cron_update_hour 设置（默认为4点）会确保重量级的缓存更新任务每天只在凌晨执行一次。高频触发可以保证任务失败后能自动重试。

点击“添加”。

步骤五：部署！
完成以上所有步骤后，点击页面顶部的“保存并部署”。现在，访问您的 Worker 地址（例如 gdrive-indexer.your-username.workers.dev），您应该就能看到您的 Google Drive 文件列表了！

📖 使用说明
前端界面
云盘切换: 页面顶部的下拉菜单可以切换不同的挂载盘。

搜索: 输入关键词即可在当前云盘内搜索文件。首次搜索会触发全盘扫描，可能较慢，之后会非常快。

主题切换: 点击右上角齿轮 ⚙️ 图标，选择“切换主题”。

文件播放: 点击视频或音频文件会进入增强的播放页面。

后台管理
访问: 在您的 Worker 地址后加上 /admin/ 即可访问，例如 .../admin/。

登录: 输入您在 ADMIN_PASS 环境变量中设置的密码。

功能:

系统状态总览: 查看云盘总数、缓存状态、文件总数和 Cron 任务等信息。

云盘管理:

清理: 清除指定云盘的所有缓存（包括列表缓存和搜索缓存）。当您发现文件列表不更新时可以使用此功能。

更新: 手动强制更新指定云盘的搜索缓存（全量文件列表）。

清理所有缓存: 一键清除所有云盘的所有缓存数据。

⚙️ 进阶配置 (脚本内)
您可以直接在脚本的 authConfig 对象中修改一些默认行为：

siteName: 网站显示的名称。

browsing_cache_ttl: 浏览缓存的有效期（秒）。默认为12小时。用户访问文件夹时生成。

cron_cache_ttl: Cron任务生成的搜索缓存有效期（秒）。默认为24小时。

cron_update_hour: Cron任务执行全盘扫描的最早时间（UTC+8时区）。默认为 4，即凌晨4点。

files_list_page_size: 文件夹列表每页显示的项目数。

❓ 常见问题 (FAQ)
1. 这个脚本会消耗很多 Cloudflare 免费资源吗？

不会。脚本经过精心设计，对资源消耗非常友好。

读取 (Read): 免费额度 10万次/天。正常浏览和搜索消耗量很低，完全足够。

写入 (Write): 免费额度 1000次/天。仅在首次搜索或 Cron 自动更新时消耗几次，远低于限额。

列出 (List): 免费额度 1000次/天。此操作仅在您于后台手动点击“清理缓存”时才会使用，日常使用消耗为零。

2. 为什么第一次搜索很慢？

因为脚本需要扫描您的整个云盘来建立用于搜索的缓存。这个过程只发生一次。一旦缓存建立，后续的搜索将是秒级的。

3. 我上传/删除了文件，为什么网站上没有变化？

这是因为缓存机制。浏览缓存默认12小时过期，搜索缓存默认24小时由 Cron 任务更新。如果您想立即看到变化，可以去后台管理页面为对应的云盘清理缓存或强制更新。

4. 部署后提示配置错误怎么办？

请仔细检查您的 DRIVE_ROOTS 环境变量是否是严格的、单行的、没有多余逗号或注释的 JSON 格式。这是最常见的错误来源。同时，请确认所有5个环境变量都已正确设置。
